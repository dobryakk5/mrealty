# Скрипт сопоставления станций метро ЦИАН ↔ БД

Этот скрипт предназначен для сопоставления названий станций метро из объявлений ЦИАН с официальным списком станций московского метро и проставления `cian_id` в таблице `metro`.

## Что делает скрипт

1. **Создает таблицу `metro`** в базе данных (если её нет)
2. **Загружает данные** из файла `stations.csv` в таблицу `metro`
3. **Сопоставляет названия станций** из объявлений ЦИАН с названиями в таблице `metro`
4. **Проставляет `cian_id`** для каждой найденной станции
5. **Экспортирует результаты** в CSV файл для анализа

## Структура таблицы metro

```sql
CREATE TABLE metro (
    id SERIAL PRIMARY KEY,
    line_id INTEGER,           -- ID линии метро
    line_name TEXT,            -- Название линии метро
    station_id INTEGER,        -- ID станции (из ЦИАН)
    station_name TEXT,         -- Название станции
    cian_id INTEGER,           -- CIAN ID (проставляется после сопоставления)
    created_at TIMESTAMP       -- Время создания записи
);
```

## Алгоритм сопоставления

Скрипт использует многоуровневый алгоритм поиска совпадений:

1. **Точное совпадение** (уверенность = 1.0)
   - Нормализованные названия полностью совпадают

2. **Частичное совпадение** (уверенность = 0.7-0.99)
   - Одно название содержит другое
   - Вычисляется на основе длины совпадающей части

3. **Словесное совпадение** (уверенность = 0.4-0.7)
   - Использует Jaccard similarity для сравнения слов
   - Учитывает длину слов для нормализации score

## Нормализация названий

Перед сравнением названия станций проходят нормализацию:

- Приведение к нижнему регистру
- Удаление лишних пробелов
- Удаление скобок и их содержимого
- Удаление слов "метро" и "станция" в конце

## Требования

- Python 3.7+
- Файл `stations.csv` с данными о станциях метро
- Доступ к базе данных PostgreSQL
- Переменная окружения `DATABASE_URL`

## Установка зависимостей

```bash
pip install asyncpg python-dotenv
```

## Использование

1. **Подготовьте файл `stations.csv`**:
   ```csv
   line_id,line_name,station_id,station_name
   4,Калининско-Солнцевская,536,Пыхтино
   ```

2. **Настройте подключение к БД** в файле `.env`:
   ```
   DATABASE_URL=postgresql://user:password@localhost:5432/database
   ```

3. **Запустите скрипт**:
   ```bash
   python metro_mapping.py
   ```

## Выходные файлы

После выполнения скрипт создает:

- **`metro_mapping_results.csv`** - полные результаты сопоставления
- **Логи в консоли** - детальная информация о процессе

## Пример вывода

```
=== СОПОСТАВЛЕНИЕ СТАНЦИЙ МЕТРО ===
Найдено 482 станций в таблице metro
Найдено 156 уникальных названий метро в объявлениях ЦИАН

Сопоставление станций:
--------------------------------------------------------------------------------
ЦИАН: 'м. Пыхтино'
  ✓ ТОЧНОЕ совпадение: 'Пыхтино' (ID: 536)
  ✓ Обновлен cian_id = 536

ЦИАН: 'м. Авиамоторная'
  ✓ ТОЧНОЕ совпадение: 'Авиамоторная' (ID: 1)
  ✓ Обновлен cian_id = 1

...

=== ИТОГИ СОПОСТАВЛЕНИЯ ===
Точных совпадений: 142
Частичных совпадений: 8
Без совпадений: 6
Обновлено записей в БД: 150
```

## Анализ результатов

Скрипт показывает:

- **Точные совпадения** - станции, найденные с уверенностью 100%
- **Частичные совпадения** - станции с уверенностью 70-99%
- **Сопоставления с низкой уверенностью** - для ручной проверки
- **Несопоставленные станции** - требующие внимания

## Ручная корректировка

Для станций с низкой уверенностью сопоставления:

1. Просмотрите список в выводе скрипта
2. Определите правильные соответствия
3. Внесите изменения в БД вручную или модифицируйте алгоритм

## Возможные улучшения

- Добавить словарь синонимов для сложных случаев
- Реализовать интерактивный режим для ручной корректировки
- Добавить веб-интерфейс для просмотра результатов
- Интегрировать с API московского метро для актуальных данных
