# Автоматическое заполнение metro_id

## Описание

Теперь при парсинге объявлений CIAN автоматически заполняется поле `metro_id` на основе сопоставления названий станций метро.

## Как это работает

### 1. Парсинг объявлений
В функции `parse_offer_card` извлекается:
- `metro` - название станции метро (например: "м. Маяковская")
- `walk_minutes` - время в пути до метро
- `metro_id` - устанавливается в `None` (будет заполнен позже)

### 2. Сохранение в БД
В функции `save_cian_ad` происходит:
- Поиск `metro_id` по названию станции в таблице `metro`
- Автоматическое сопоставление с учетом:
  - Точного совпадения (регистронезависимо)
  - Удаления префикса "м." в начале названия
- Сохранение `metro_id` вместе с остальными данными

### 3. Структура таблицы ads_cian
```sql
CREATE TABLE ads_cian (
    -- ... другие поля ...
    metro TEXT,           -- Название станции из ЦИАН
    metro_id INTEGER,     -- ID станции из таблицы metro
    min_metro SMALLINT,   -- Время в пути до метро
    -- ... другие поля ...
);
```

## Примеры сопоставления

| Название из ЦИАН | Очищенное название | metro_id | Станция |
|------------------|-------------------|----------|---------|
| "м. Маяковская" | "Маяковская" | 27 | Маяковская |
| "Перово" | "Перово" | 138 | Перово |
| "м. Новогиреево" | "Новогиреево" | 137 | Новогиреево |

## Преимущества

1. **Автоматическое сопоставление** - не нужно вручную заполнять metro_id
2. **Связь с таблицей metro** - можно делать JOIN запросы для анализа по станциям
3. **Консистентность данных** - все объявления с одинаковой станцией имеют одинаковый metro_id
4. **Упрощение запросов** - поиск по metro_id вместо текстового поиска по metro

## Использование

При запуске парсера CIAN:
```bash
python parse_cian_to_db.py
```

Все новые объявления автоматически получат `metro_id` на основе сопоставления с таблицей `metro`.

## Запросы с metro_id

Теперь можно делать эффективные запросы:

```sql
-- Объявления у конкретной станции
SELECT * FROM ads_cian WHERE metro_id = 27;

-- Статистика по станциям
SELECT m.name, COUNT(*) as ads_count
FROM ads_cian a
JOIN metro m ON a.metro_id = m.id
GROUP BY m.id, m.name
ORDER BY ads_count DESC;
```
