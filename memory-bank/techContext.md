## Project map (single source of truth) ‚Äî mrealty

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∫–æ—Ä–æ—Ç–∫–∞—è ¬´–º–∞–ø–∞¬ª –ø—Ä–æ–µ–∫—Ç–∞. –ß–∏—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞, –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–≥–æ–≤ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏. –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è —Å –∫–æ–¥–æ–º ‚Äî –¥–æ–≤–µ—Ä—è–µ–º –∫–æ–¥—É –∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–æ—Ç —Ñ–∞–π–ª.

### –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- `main.py`: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è aiogram `Bot`/`Dispatcher`, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤, —Ä–æ—Ç–∞—Ü–∏–æ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–ø—É—Å–∫ polling.

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- `start_handlers.py`: `on_start(message)` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å ¬´üìò –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è¬ª.
- `text_handlers.py`:
  - `handle_text_message(message)` ‚Äî —Ä–∞–∑–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—Å—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ¬´–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é¬ª, –∏–∑–≤–ª–µ–∫–∞–µ—Ç URL.
  - `_handle_listings_export(urls, message)` ‚Äî —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç 2 Excel-—Ñ–∞–π–ª–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

### –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- `listings_processor.py`:
  - `extract_urls(text)` ‚Äî –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç URL –∏–∑ —Ç–µ–∫—Å—Ç–∞.
  - `parse_listing(url, session)` ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã CIAN (`requests` + `BeautifulSoup`).
  - `export_listings_to_excel(listing_urls, user_id, output_path?)` ‚Äî –ø–∞—Ä—Å–∏—Ç —Å–ø–∏—Å–æ–∫, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î (`save_listings`) –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π Excel.
  - `export_sim_ads(request_id, output_path?)` ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –≤—Ç–æ—Ä–æ–π Excel –ø–æ –ø–æ—Ö–æ–∂–∏–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º (–∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏–∑ –ë–î).

### –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
- `db_handler.py` (PostgreSQL, `asyncpg`):
  - –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, `init_schema()` (—Å—Ö–µ–º–∞ `users`, —Ç–∞–±–ª–∏—Ü—ã `requests`, `listings`).
  - `save_listings(rows, user_id)` ‚Üí —Å–æ–∑–¥–∞—ë—Ç `request_id`, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è.
  - `find_similar_ads_grouped(request_id)` ‚Üí –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π.
  - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π (`clean_numeric`), –ø–∞—Ä—Å–∏–Ω–≥ —ç—Ç–∞–∂–µ–π/–ª–∏—Ñ—Ç–æ–≤/—Å—á—ë—Ç—á–∏–∫–æ–≤.

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- `standalone/*` ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã (selenium, —Ç–µ—Å—Ç—ã, –¥–æ–º–∫–ª–∏–∫ –∏ —Ç.–ø.), –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–Ω—Ç–∞–π–º–æ–º –±–æ—Ç–∞.

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (—Å–∫–≤–æ–∑–Ω–æ–π –ø—É—Ç—å)
Telegram ‚Üí `main.py` ‚Üí `text_handlers.py` ‚Üí `listings_processor.py` ‚Üí `db_handler.py` ‚Üí Excel (–≤ –ø–∞–º—è—Ç–∏ —á–µ—Ä–µ–∑ `BytesIO`) ‚Üí Telegram

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `.env`: `API_TOKEN` (Telegram Bot API), `DATABASE_URL` (PostgreSQL).
- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–∞–π–º—Å—Ç–∞–º–ø–æ–≤ –≤ –ë–î ‚Äî Europe/Moscow (—Å–º. `db_handler.py`).

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ `TimedRotatingFileHandler` (–∫–µ–∂–µ—Å—É—Ç–æ—á–Ω–æ), –≤—ã–≤–æ–¥ –≤ `logs/bot.log` + –∫–æ–Ω—Å–æ–ª—å. –§–æ—Ä–º–∞—Ç: `"%(asctime)s [%(levelname)s] %(message)s"`.

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–∫—Ä–∞—Ç–∫–æ)
- `users.requests(id, userid, ts)` ‚Äî –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- `users.listings(...)` ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è + `other JSONB` –¥–ª—è –Ω–µ—Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π.
- –í–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏: `listings.request_id` ‚Üí `requests.id` (ON DELETE CASCADE).

### –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—è–¥—Ä–æ)
- aiogram, requests, beautifulsoup4, pandas, openpyxl, asyncpg, python-dotenv.
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤ `standalone`: selenium / seleniumbase.

### –ü—Ä–∞–≤–∏–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ (–¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)
1) –≠—Ç–æ—Ç —Ñ–∞–π–ª —á–∏—Ç–∞–µ—Ç—Å—è –ü–ï–†–í–´–ú –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –ª—é–±–æ–π –∑–∞–¥–∞—á–∏ –∏–ª–∏ –ø—Ä–∞–≤–∫–∏.
2) –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è —Å –∫–æ–¥–æ–º ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É –∫–æ–¥–∞; —Ñ–∞–π–ª —Å–ª–µ–¥—É–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã—è–≤–ª–µ–Ω–∏—è.
3) –í—Å–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è/–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–¥–µ—Å—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø—É–Ω–∫—Ç–∞–º–∏.

### MCP –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MCP Context7 –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–º. `memory-bank/activeContext.md`).

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã/–∑–∞–º–µ—Ç–∫–∏
- –ò–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ –≤ Excel –Ω–∞ —Ä—É—Å—Å–∫–æ–º; —Ü–µ–Ω–∞ —Å–Ω–∞—á–∞–ª–∞ –∫–∞–∫ `–¶–µ–Ω–∞_raw`, –∑–∞—Ç–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è –∏ –≤—ã–≤–æ–¥–∏—Ç—Å—è –∫–∞–∫ `–¶–µ–Ω–∞`.
- `parse_lifts` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑–¥–µ–ª—å–Ω–æ –ø–∞—Å—Å–∞–∂–∏—Ä—Å–∫–∏–µ/–≥—Ä—É–∑–æ–≤—ã–µ –ª–∏—Ñ—Ç—ã.
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–ê–∫—Ç–∏–≤–Ω–æ/–°–Ω—è—Ç–æ) –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Ç–µ–∫—Å—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel ‚Äî —á–µ—Ä–µ–∑ `pandas`/`openpyxl`, bold –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, —Ñ–æ—Ä–º–∞—Ç —Ç—ã—Å—è—á –¥–ª—è —Ü–µ–Ω—ã.


