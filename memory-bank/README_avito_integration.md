# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Avito –≤ listings_processor

## –û–±–∑–æ—Ä

`listings_processor.py` —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∫–∞–∫ —Å **Cian**, —Ç–∞–∫ –∏ —Å **Avito**. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫ —Å—Å—ã–ª–∫–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä—Å–µ—Ä.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### üè† –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏

- **Avito** (source = 1) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Selenium WebDriver —Å cookies
- **Cian** (source = 4) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç requests + BeautifulSoup
- **–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏** (source = 0) - –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

### üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

```python
processor = ListingsProcessor()

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å—Å—ã–ª–∫–∏
if processor.is_avito_url(url):
    print("–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ Avito")
elif processor.is_cian_url(url):
    print("–≠—Ç–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ Cian")

# –ü–æ–ª—É—á–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤–æ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
source = processor.get_url_source(url)  # 1 –¥–ª—è Avito, 4 –¥–ª—è Cian
```

## –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã

### 1. –ü–∞—Ä—Å–∏–Ω–≥ –æ–±—ä—è–≤–ª–µ–Ω–∏–π Avito

```python
async def parse_avito_listing(self, url: str) -> dict:
    """–ü–∞—Ä—Å–∏—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Å Avito –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –ë–î"""
```

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `rooms` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç
- `price` - —Ü–µ–Ω–∞
- `floor` - —ç—Ç–∞–∂
- `area_m2` - –ø–ª–æ—â–∞–¥—å –≤ –º¬≤
- `walk_minutes` - –≤—Ä–µ–º—è –¥–æ –º–µ—Ç—Ä–æ
- `address` - –∞–¥—Ä–µ—Å
- `tags` - —Ç–µ–≥–∏
- `person` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥–∞–≤—Ü–µ
- `person_type` - —Ç–∏–ø –ø—Ä–æ–¥–∞–≤—Ü–∞
- `metro_id` - ID –º–µ—Ç—Ä–æ
- –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

### 2. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥

```python
async def parse_listing_universal(self, url: str) -> dict:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å Cian –∏ Avito"""
```

### 3. –ü–∞–∫–µ—Ç–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥

```python
async def parse_listings_batch(self, listing_urls: list[str]) -> list[dict]:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–ø–∏—Å–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π —Å Cian –∏ Avito"""
```

### 4. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π Avito

```python
def extract_avito_photo_urls(self, soup: BeautifulSoup) -> list[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å Avito"""
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –±–æ—Ç–µ

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫

```python
from listings_processor import ListingsProcessor

processor = ListingsProcessor()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫)
listing_data = await processor.parse_listing_universal(url)

if listing_data:
    source = listing_data.get('source', 0)
    if source == 1:
        print("–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å Avito")
    elif source == 4:
        print("–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å Cian")
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –≥–∞–ª–µ—Ä–µ–∏

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∫ Cian, —Ç–∞–∫ –∏ Avito
html_content = processor.generate_html_gallery(listing_urls, user_id, subtitle)
```

### –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–º–µ—à–∞–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
excel_file, request_id = await export_listings_to_excel(listing_urls, user_id)
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

### –ü–æ–ª–µ `source`

- **1** - Avito
- **4** - Cian

### –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö Avito

```python
{
    'URL': 'https://www.avito.ru/...',
    'rooms': 2,
    'price': 8500000,
    'floor': 5,
    'area_m2': 45.5,
    'walk_minutes': 15,
    'address': '—É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 123',
    'tags': '–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫, –†–µ–º–æ–Ω—Ç',
    'person': '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
    'person_type': '—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫',
    'metro_id': 1,
    'source': 1  # Avito
}
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –î–ª—è Avito –ø–∞—Ä—Å–∏–Ω–≥–∞

1. **Selenium WebDriver** - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±—Ä–∞—É–∑–µ—Ä–æ–º
2. **Chrome/Chromium** - –±—Ä–∞—É–∑–µ—Ä –¥–ª—è WebDriver
3. **Cookies —Ñ–∞–π–ª** - `avito_cookies.json` —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
4. **–ú–æ–¥—É–ª—å parse_avito_1metro** - –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä Avito

### –î–ª—è Cian –ø–∞—Ä—Å–∏–Ω–≥–∞

1. **requests** - –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
2. **BeautifulSoup** - –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### Avito –ø–∞—Ä—Å–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

```python
if not AVITO_AVAILABLE:
    print("‚ö†Ô∏è –ú–æ–¥—É–ª—å parse_avito_1metro –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–∞—Ä—Å–∏–Ω–≥ Avito –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
```

### –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞

```python
try:
    listing_data = await processor.parse_avito_listing(url)
    if listing_data:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        pass
    else:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–ø–∞—Ä—Å–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ Avito")
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {e}")
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø–∞—Ä—Å–∏–Ω–≥–∞:

```
üè† –ü–∞—Ä—Å–∏–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ Avito: https://www.avito.ru/...
üîÑ –ü–∞—Ä—Å–∏–º –æ–±—ä—è–≤–ª–µ–Ω–∏–µ Avito: https://www.avito.ru/...
‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ Avito —É—Å–ø–µ—à–Ω–æ —Å–ø–∞—Ä—Å–µ–Ω–æ
üìä –í—Å–µ–≥–æ —É—Å–ø–µ—à–Ω–æ —Å–ø–∞—Ä—Å–µ–Ω–æ: 1 –∏–∑ 1
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

```bash
python test_avito_integration.py
```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ Avito** - —Ç—Ä–µ–±—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–±–∞–∑–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞)
2. **Cookies** - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Avito
3. **Selenium** - –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - Avito –ø–∞—Ä—Å–∏–Ω–≥ –º–µ–¥–ª–µ–Ω–Ω–µ–µ Cian –∏–∑-–∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–æ–¥—É–ª—è `parse_avito_1metro`
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ cookies
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Selenium WebDriver
4. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫
