# Решение проблемы множественных процессов Chromium

## Проблема
При использовании Selenium WebDriver для парсинга Avito создается много процессов Chromium, которые потребляют много памяти и не закрываются корректно.

## Причины
1. **Selenium создает новые экземпляры браузера** при каждом запуске
2. **Браузер не закрывается корректно** при аварийном завершении
3. **Множественные запуски** парсера подряд
4. **Отсутствие обработки сигналов** для корректного завершения

## Решения

### 1. Улучшенный парсер (parse_avito_1metro.py)
- ✅ Добавлен метод `cleanup()` для корректного закрытия браузера
- ✅ Обработка сигналов SIGINT (Ctrl+C) и SIGTERM
- ✅ Гарантированная очистка ресурсов в блоке `finally`
- ✅ Деструктор класса для автоматической очистки

### 2. Скрипт очистки (cleanup_chromium.py)
Автоматически находит и убивает зависшие процессы Chromium.

#### Установка зависимостей:
```bash
pip install -r requirements.txt
```

#### Использование:
```bash
# Интерактивная очистка с подтверждением
python cleanup_chromium.py

# Принудительная очистка без подтверждения
python cleanup_chromium.py --force
```

### 3. Ручная очистка через терминал
```bash
# Найти процессы Chromium
ps aux | grep chromium

# Убить конкретный процесс
kill -9 <PID>

# Убить все процессы Chromium
pkill -f chromium
```

## Рекомендации по использованию

### 1. Всегда используйте улучшенный парсер
```bash
python parse_avito_1metro.py
```

### 2. Для корректного завершения используйте Ctrl+C
Парсер автоматически закроет браузер и очистит ресурсы.

### 3. Регулярно проверяйте процессы
```bash
# Проверить потребление памяти
ps aux | grep chromium | awk '{sum+=$6} END {print "Total RSS:", sum/1024, "MB"}'
```

### 4. Автоматическая очистка при запуске
Добавьте в скрипт запуска:
```bash
# Очистить старые процессы перед запуском
python cleanup_chromium.py --force
python parse_avito_1metro.py
```

## Мониторинг ресурсов

### Проверка процессов в реальном времени:
```bash
watch -n 1 'ps aux | grep chromium | grep -v grep'
```

### Проверка потребления памяти:
```bash
ps aux | grep chromium | grep -v grep | awk '{sum+=$6} END {print "Total RSS:", sum/1024, "MB"}'
```

## Предотвращение проблемы

1. **Не запускайте несколько парсеров одновременно**
2. **Всегда дожидайтесь завершения парсера**
3. **Используйте Ctrl+C для корректного завершения**
4. **Регулярно перезагружайте систему** для очистки памяти

## Структура файлов
```
mrealty/
├── parse_avito_1metro.py      # Улучшенный парсер с очисткой
├── cleanup_chromium.py        # Скрипт очистки процессов
├── requirements.txt           # Зависимости Python
└── README_chromium_cleanup.md # Этот файл
```

## Поддержка
При возникновении проблем:
1. Запустите `cleanup_chromium.py --force`
2. Перезагрузите систему
3. Проверьте логи парсера
4. Убедитесь, что все зависимости установлены
