#!/usr/bin/env python3
"""
–ë—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –æ–¥–Ω–æ–≥–æ –º–µ—Ç—Ä–æ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python quick_metro_parse.py <metro_id> <max_pages> [max_cards]
"""

import asyncio
import sys
import os
from dotenv import load_dotenv
from parse_avito_1metro import EnhancedMetroParser

# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ò –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ - –ò–ó–ú–ï–ù–ò–¢–ï –ò–• –ü–û–î –í–ê–®–ò –ù–£–ñ–î–´
# =============================================================================

# –ú–µ—Ç—Ä–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (ID –∏–∑ —Ç–∞–±–ª–∏—Ü—ã metro)
DEFAULT_METRO_ID = 11

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (0 = –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
DEFAULT_MAX_PAGES = 0

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (0 = –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏)
DEFAULT_MAX_CARDS = 0

# –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (1 = –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
DEFAULT_START_PAGE = 1

# =============================================================================
# –ö–û–ù–ï–¶ –ù–ê–°–¢–†–û–ï–ö
# =============================================================================

async def quick_parse_metro(metro_id, max_pages, max_cards=None, start_page=1):
    """
    –ë—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –æ–¥–Ω–æ–≥–æ –º–µ—Ç—Ä–æ
    
    Args:
        metro_id (int): ID –º–µ—Ç—Ä–æ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã metro
        max_pages (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        max_cards (int, optional): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        start_page (int, optional): –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Å –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—á–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
    """
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_dotenv()
    
    # –ü–æ–ª—É—á–∞–µ–º DATABASE_URL
    database_url = os.getenv('DATABASE_URL')
    if not database_url:
        print("‚ùå –û—à–∏–±–∫–∞: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")
        print("üí° –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:")
        print("   DATABASE_URL=postgresql://username:password@host:port/database")
        return False
    
    # –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Å–µ—Ä
    parser = EnhancedMetroParser()
    parser.database_url = database_url
    
    print(f"üöÄ –ë—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –º–µ—Ç—Ä–æ ID={metro_id}")
    print(f"üìÑ –°—Ç—Ä–∞–Ω–∏—Ü: {max_pages if max_pages > 0 else '–≤—Å–µ'}")
    print(f"üìä –ö–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: {max_cards if max_cards and max_cards > 0 else '–≤—Å–µ'}")
    if start_page > 1:
        print(f"üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {start_page}")
    print("=" * 60)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥
    success, saved_count, total_cards = await parser.parse_single_metro(
        metro_id=metro_id,
        max_pages=max_pages,
        max_cards=max_cards,
        start_page=start_page
    )
    
    # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if success:
        print(f"\nüéâ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:")
        print(f"   ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î: {saved_count}")
        print(f"   ‚Ä¢ –í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫: {total_cards}")
        return True
    else:
        print(f"\n‚ùå –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–∞–º–∏")
        return False

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if len(sys.argv) < 2:
        print("üöÄ –ó–∞–ø—É—Å–∫ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        print(f"‚öôÔ∏è –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:")
        print(f"   ‚Ä¢ –ú–µ—Ç—Ä–æ ID: {DEFAULT_METRO_ID}")
        print(f"   ‚Ä¢ –°—Ç—Ä–∞–Ω–∏—Ü: {DEFAULT_MAX_PAGES if DEFAULT_MAX_PAGES > 0 else '–≤—Å–µ'}")
        print(f"   ‚Ä¢ –ö–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: {DEFAULT_MAX_CARDS if DEFAULT_MAX_CARDS > 0 else '–≤—Å–µ'}")
        print(f"   ‚Ä¢ –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {DEFAULT_START_PAGE}")
        print("=" * 60)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        success = asyncio.run(quick_parse_metro(DEFAULT_METRO_ID, DEFAULT_MAX_PAGES, DEFAULT_MAX_CARDS, DEFAULT_START_PAGE))
        
        if success:
            sys.exit(0)  # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        else:
            sys.exit(1)  # –û—à–∏–±–∫–∞
    
    # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω ID –º–µ—Ç—Ä–æ, –Ω–æ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
    if len(sys.argv) == 2 and sys.argv[1] in ['-h', '--help', 'help', '?']:
        print("üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:")
        print("   python quick_metro_parse.py                                    # –ó–∞–ø—É—Å–∫ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        print("   python quick_metro_parse.py <metro_id>                         # –ú–µ—Ç—Ä–æ ID, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        print("   python quick_metro_parse.py <metro_id> <pages>                 # –ú–µ—Ç—Ä–æ ID + —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        print("   python quick_metro_parse.py <metro_id> <pages> <cards>         # –ú–µ—Ç—Ä–æ ID + —Å—Ç—Ä–∞–Ω–∏—Ü—ã + –∫–∞—Ä—Ç–æ—á–∫–∏")
        print("   python quick_metro_parse.py <metro_id> <pages> <cards> <start> # –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã + –Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞")
        print("\nüìù –ü—Ä–∏–º–µ—Ä—ã:")
        print("   python quick_metro_parse.py                    # –ú–µ—Ç—Ä–æ ID=95, –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏")
        print("   python quick_metro_parse.py 1                 # –ú–µ—Ç—Ä–æ ID=1, –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏")
        print("   python quick_metro_parse.py 1 3               # –ú–µ—Ç—Ä–æ ID=1, 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏")
        print("   python quick_metro_parse.py 2 1 15            # –ú–µ—Ç—Ä–æ ID=2, 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞, 15 –∫–∞—Ä—Ç–æ—á–µ–∫")
        print("   python quick_metro_parse.py 5 0 0             # –ú–µ—Ç—Ä–æ ID=5, –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏")
        print("   python quick_metro_parse.py 3 2 0             # –ú–µ—Ç—Ä–æ ID=3, 2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏")
        print("   python quick_metro_parse.py 1 5 20 3          # –ú–µ—Ç—Ä–æ ID=1, 5 —Å—Ç—Ä–∞–Ω–∏—Ü, 20 –∫–∞—Ä—Ç–æ—á–µ–∫, –Ω–∞—á–∞—Ç—å —Å 3-–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã")
        print(f"\n‚öôÔ∏è –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:")
        print(f"   ‚Ä¢ –ú–µ—Ç—Ä–æ ID: {DEFAULT_METRO_ID}")
        print(f"   ‚Ä¢ –°—Ç—Ä–∞–Ω–∏—Ü: {DEFAULT_MAX_PAGES if DEFAULT_MAX_PAGES > 0 else '–≤—Å–µ'}")
        print(f"   ‚Ä¢ –ö–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: {DEFAULT_MAX_CARDS if DEFAULT_MAX_CARDS > 0 else '–≤—Å–µ'}")
        print(f"   ‚Ä¢ –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {DEFAULT_START_PAGE}")
        print("\nüí° –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:")
        print(f"   ‚Ä¢ –°—Ç—Ä–∞–Ω–∏—Ü = 0: –ø–∞—Ä—Å–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã")
        print(f"   ‚Ä¢ –ö–∞—Ä—Ç–æ—á–µ–∫ = 0: –ø–∞—Ä—Å–∏—Ç—å –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ")
        print(f"   ‚Ä¢ –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ = 1: –Ω–∞—á–∞—Ç—å —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã")
        return
    
    try:
        # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
        metro_id = int(sys.argv[1])
        
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –±–µ—Ä–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if len(sys.argv) > 2:
            max_pages = int(sys.argv[2])
        else:
            max_pages = DEFAULT_MAX_PAGES
            print(f"üìÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {max_pages}")
        
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –±–µ—Ä–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if len(sys.argv) > 3:
            max_cards = int(sys.argv[3])
        else:
            max_cards = DEFAULT_MAX_CARDS
            print(f"üìä –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {max_cards if max_cards > 0 else '–≤—Å–µ'}")
        
        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë, –∏–Ω–∞—á–µ –±–µ—Ä–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if len(sys.argv) > 4:
            start_page = int(sys.argv[4])
        else:
            start_page = DEFAULT_START_PAGE
            if start_page > 1:
                print(f"üöÄ –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {start_page}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        if metro_id <= 0:
            print("‚ùå ID –º–µ—Ç—Ä–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
            return
        
        if max_pages < 0:
            print("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
            return
        
        if max_cards is not None and max_cards < 0:
            print("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
            return
        
        if start_page < 1:
            print("‚ùå –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
            return
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥
        success = asyncio.run(quick_parse_metro(metro_id, max_pages, max_cards, start_page))
        
        if success:
            sys.exit(0)  # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        else:
            sys.exit(1)  # –û—à–∏–±–∫–∞
            
    except ValueError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞ - {e}")
        print("üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ metro_id –∏ max_pages - —ç—Ç–æ —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞")
    except KeyboardInterrupt:
        print("\n‚ö†Ô∏è –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(1)
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
