# Парсер CIAN с отслеживанием прогресса

Парсер объявлений CIAN с сохранением в БД и системой отслеживания прогресса.

## Возможности

- Парсинг объявлений по типу недвижимости (вторичка/новостройки)
- Фильтрация по времени публикации (час/день/неделя/без ограничений)
- Фильтрация по станциям метро
- Фильтрация по времени в пути до метро
- Система отслеживания прогресса с возможностью возобновления
- Поддержка прокси

## Параметры запуска

### Основные параметры
```bash
python parse_cian_to_db.py [тип][период]
```

**Тип недвижимости:**
- `1` - вторичка
- `2` - новостройки

**Период времени:**
- `h` - час
- `d` - день (использует специальное значение CIAN API: `-2`)
- `w` - неделя
- `none` - без ограничений по времени

### Примеры использования
```bash
# Вторичка за день
python parse_cian_to_db.py 1d

# Новостройки за неделю
python parse_cian_to_db.py 2w

# Вторичка за час
python parse_cian_to_db.py 1h

# Новостройки без ограничений по времени
python parse_cian_to_db.py 2none

# Значения по умолчанию (вторичка за неделю)
python parse_cian_to_db.py
```

### Параметры прокси
```bash
# Включить прокси (использует PROXY из настроек)
python parse_cian_to_db.py 1d --proxy

# Отключить прокси
python parse_cian_to_db.py 1d --no-proxy

# По умолчанию прокси включен (если настроен)
python parse_cian_to_db.py 1d
```

## Система отслеживания прогресса

### Таблица прогресса
Парсер автоматически создает таблицу `system.parsing_progress` для отслеживания:

- `property_type` - тип недвижимости
- `time_period` - период времени (может быть NULL)
- `current_metro_id` - текущая станция метро
- `status` - статус сессии (active/completed)
- `total_metros` - общее количество станций
- `processed_metros` - количество обработанных станций

### Возобновление работы
При повторном запуске с теми же параметрами парсер автоматически:
1. Проверяет наличие незавершенной сессии
2. Находит последнюю обработанную станцию
3. Продолжает работу с места остановки

### Пример работы с прогрессом
```bash
# Первый запуск - создается сессия
python parse_cian_to_db.py 1d

# Прерывание работы (Ctrl+C)

# Повторный запуск - продолжается с места остановки
python parse_cian_to_db.py 1d
```

## Настройки

### Основные параметры в коде
```python
PROPERTY_TYPE = 1          # 1=вторичка, 2=новостройки
TIME_PERIOD = None         # None=без ограничений, или конкретное значение
METRO_ID = "all"          # "all" для всех станций, или конкретный ID
FOOT_MIN = 20             # Время до метро в минутах
PROXY = "http://..."      # Прокси сервер
```

### База данных
Требуется переменная окружения `DATABASE_URL` с подключением к PostgreSQL.

## Тестирование

Для проверки работы системы прогресса:
```bash
python test_progress.py
```

## Структура БД

### Таблица ads_cian
Основная таблица для хранения объявлений с полями:
- `url`, `avitoid`, `price`, `rooms`, `area`
- `floor`, `total_floors`, `complex`, `metro_id`
- `min_metro`, `address`, `district_id`, `tags`
- `person_type`, `person`, `object_type_id`

### Таблица system.parsing_progress
Таблица для отслеживания прогресса парсинга.

## Логирование

Парсер выводит подробную информацию о:
- Создании/возобновлении сессий
- Обработке станций метро
- Прогрессе парсинга
- Ошибках и предупреждениях

## Особенности

1. **Значение -2 для дня**: CIAN API использует специальное значение `-2` для фильтра "за день"
2. **Автоматическое возобновление**: Система автоматически находит место остановки
3. **Обработка дубликатов**: Остановка при обнаружении страниц только с дубликатами
4. **Паузы между запросами**: Автоматические задержки для соблюдения лимитов CIAN
